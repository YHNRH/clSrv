import java.util.*;

import java.nio.charset.StandardCharsets;
import java.net.Socket;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.*;
import java.io.PrintWriter;
import java.io.DataInputStream;
import java.io.DataOutputStream;

public class Client
{
    public static void main(String[] a)
    {
	int state = 0; // 0 -- out 1 -- in chat room
	Scanner scaner  = new Scanner(System.in);
	String  request = "ERROR";
	String  reply   = "ERROR";
	System.out.println("Enter your name");
	String name = scaner.nextLine();
	
	try (
	     Socket socket  = new Socket("localhost", 8080);

	     )
	    {
		
		try (
		     DataInputStream input   = new DataInputStream(socket.getInputStream());
		     DataOutputStream output = new DataOutputStream(socket.getOutputStream())) {
		    
		    output.writeUTF(name);
		    output.flush();
		    System.out.println("You're connected!");

		     
		    Thread thread = new Thread(() ->
					       {
						   while(true)
						       {
							   try{
							       //      if(state == 1)
							       System.out.println(input.readUTF());
							   }
							   catch(Exception e)
							       {
								   System.out.println("ERRORRRRR");
							       }
							   try
							       {
								   Thread.sleep(50);
							       }
							   catch(Exception e)
							       {}
						       }
					       });
		   
		    

		    
		    while (!(request.equals("quit") && state == 0))
			{
			    reply = "ERROR";
			    Date date = new Date();
			    
			    if (state == 0)
				System.out.print(name +"> ");
			    else if (state == 1)
				System.out.print(date + " "+ name +"> ");
			    			
			    request = scaner.nextLine();
			    output.writeUTF(request);
			    output.flush();

			    if (state == 0)
			    reply = input.readUTF();

			    if (reply.equals("---- You're entered chat room ----"))
				{
				    state = 1;
				    System.out.println("---- You're entered chat room ----");
				    thread.start();
				}
			    
			    else if(reply.equals("---- You're left chat room ----"))
				state = 0;
			    if (state == 0)
				System.out.println(reply);
			}

                    
                }
		 catch (IOException ex) {
		     ex.printStackTrace();
        }

	    
	    }
	catch (IOException ex) {
	    System.out.println("Cannot connect to server");
	}
    }
}
